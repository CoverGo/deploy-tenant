# File generated by gflows, do not modify
# Source: .gflows/workflows/deploy-tenants
name: Self-Hosted Tenants Deploy
"on":
  workflow_run:
    workflows:
    - Build and publish
    types:
    - completed
    branches:
    - master
    - main
jobs:
  version:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    name: Get version from git tag
    outputs:
      app_version: ${{ steps.version.outputs.app_version }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Checkout GitHub Action Repos
      uses: daspn/private-actions-checkout@v2
      with:
        actions_list: '["covergo/get-version@v1.4","covergo/get-issue-key@v1.2","covergo/docker-extract@v1","covergo/docker-diagnose@v1.2","covergo/set-compose-tags@v1","covergo/run-in-compose@v1"]'
        checkout_base_path: ./.github/actions
        app_id: ${{ secrets.PRIVATE_ACTION_APP_ID }}
        app_private_key: ${{ secrets.PRIVATE_ACTION_APP_PRIVATE_KEY }}
    - name: Get jira Ticket slug
      id: issue-key
      uses: ./.github/actions/get-issue-key
    - name: Get version from git tags
      id: version
      uses: ./.github/actions/get-version
  deploy-tenant_name:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted
    needs:
    - version
    name: Deploy to tenant name
    steps:
    - name: Checkout tokens repository
      uses: actions/checkout@v2
      with:
        repository: keys_repo
        ref: master
        token: ${{ github.token }}
        path: configs
    - name: Configure AWS
      run: printf  '${{ secrets.aws_key }}' | aws configure
    - name: Deploy via kubectl
      run: kubectl -n default --kubeconfig ./configs/tenant_path set image deployments/covergo-users
        covergo-users=registry-intl.cn-hongkong.aliyuncs.com/covergo/users:${{ needs.version.outputs.app_version
        }}
    - name: Check deployment
      run: kubectl -n default --kubeconfig ./configs/tenant_path rollout status deployments/covergo-users
